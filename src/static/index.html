<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contact Dashboard - Customer Management Platform</title>
    <script type="module" crossorigin src="/assets/index-BPWlosZF.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-DruAeHWO.css">
  </head>
  <body>
    <div id="root"></div>
    <script>
      (function() {
          // --- DOM INJECTION LOGIC ---
          const observer = new MutationObserver((mutationsList, observer) => {
              const form = findForm();
              if (form && !document.getElementById('http-headers-field-container')) {
                  addHeadersField(form);
              }
          });

          observer.observe(document.getElementById('root'), {
              childList: true,
              subtree: true
          });

          function findForm() {
              const dialog = document.querySelector('div[role="dialog"]');
              if (!dialog) return null;
              const urlInput = dialog.querySelector('input[name="url"]');
              const nameInput = dialog.querySelector('input[name="name"]');
              if (urlInput || nameInput) {
                  return dialog;
              }
              return null;
          }

          function addHeadersField(form) {
              const container = document.createElement('div');
              container.id = 'http-headers-field-container';
              const otherField = form.querySelector('label');
              if (otherField && otherField.parentElement) {
                  container.className = otherField.parentElement.className;
              }

              const headersLabel = document.createElement('label');
              headersLabel.innerText = 'HTTP Header';
              headersLabel.htmlFor = 'http-headers-field';
              if (otherField) {
                  headersLabel.className = otherField.className;
              }

              const headersTextarea = document.createElement('textarea');
              headersTextarea.id = 'http-headers-field';
              headersTextarea.name = 'headers';
              headersTextarea.rows = 3;
              headersTextarea.placeholder = 'e.g., {"x-make-apikey": "YOUR_API_KEY"}';
              const urlInput = form.querySelector('input[name="url"]');
              if (urlInput) {
                  headersTextarea.className = urlInput.className;
              }

              container.appendChild(headersLabel);
              container.appendChild(headersTextarea);

              const saveButton = Array.from(form.querySelectorAll('button')).find(btn => btn.textContent.includes('Save') || btn.textContent.includes('Create'));
              if (saveButton && saveButton.parentElement) {
                  const parentOfButton = saveButton.parentElement;
                  parentOfButton.parentElement.insertBefore(container, parentOfButton);
              } else {
                  form.appendChild(container);
              }
          }

          // --- FETCH INTERCEPTION FOR DATA HANDLING ---
          const originalFetch = window.fetch;
          window.fetch = async function(url, options) {
              const method = options ? options.method || 'GET' : 'GET';
              const isWebhookSettingsUrl = typeof url === 'string' && url.includes('/api/settings/webhooks');
              const isCampaignJobUrl = typeof url === 'string' && url.includes('/api/settings/campaign-jobs');

              if ((isWebhookSettingsUrl || isCampaignJobUrl) && (method === 'POST' || method === 'PUT')) {
                  const headersTextarea = document.getElementById('http-headers-field');
                  if (headersTextarea && options.body) {
                      try {
                          const body = JSON.parse(options.body);
                          let headersValue = headersTextarea.value.trim();
                          if (headersValue) {
                              try {
                                  const parsed = JSON.parse(headersValue);
                                  if (typeof parsed !== 'object' || Array.isArray(parsed) || parsed === null) {
                                      throw new Error("Headers must be a JSON object.");
                                  }
                                  body.headers = headersValue;
                              } catch (e) {
                                  console.error("Invalid JSON in HTTP Headers field", e);
                                  body.headers = headersValue;
                              }
                          } else {
                              body.headers = "{}";
                          }
                          options.body = JSON.stringify(body);
                      } catch (e) {
                          console.error("Could not modify fetch body for saving settings.", e);
                      }
                  }
              }

              const response = await originalFetch.apply(this, arguments);

              if (method === 'GET' && (isWebhookSettingsUrl || isCampaignJobUrl) && url.match(/\/(webhooks|campaign-jobs)\/[\w-]+$/)) {
                  const clonedResponse = response.clone();
                  clonedResponse.json().then(data => {
                      const configData = data.webhook || data.job;
                      if (configData && configData.headers) {
                          setTimeout(() => {
                              const headersTextarea = document.getElementById('http-headers-field');
                              if (headersTextarea) {
                                  try {
                                      const headersObj = JSON.parse(configData.headers);
                                      headersTextarea.value = JSON.stringify(headersObj, null, 2);
                                  } catch (e) {
                                      headersTextarea.value = configData.headers;
                                  }
                              }
                          }, 200);
                      }
                  });
              }

              return response;
          };
      })();
    </script>
  </body>
</html>
