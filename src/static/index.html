<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contact Dashboard - Customer Management Platform</title>
    <script type="module" crossorigin src="/assets/index-BPWlosZF.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-DruAeHWO.css">
  </head>
  <body>
    <div id="root"></div>
    <script>
      (function() {
          console.log("[DEBUG] Custom script for HTTP Header field started.");

          const observer = new MutationObserver((mutationsList, observer) => {
              console.log("[DEBUG] MutationObserver detected DOM change.");
              const form = findForm();
              if (form && !document.getElementById('http-headers-field-container')) {
                  console.log("[DEBUG] Form found, attempting to add headers field.");
                  addHeadersField(form);
              }
          });

          observer.observe(document.getElementById('root'), {
              childList: true,
              subtree: true
          });
          console.log("[DEBUG] MutationObserver is now observing #root.");

          function findForm() {
              console.log("[DEBUG] Searching for form with new logic...");
              const headings = Array.from(document.querySelectorAll('h1, h2, h3, h4, h5, h6'));
              const targetHeading = headings.find(h => h.textContent.includes('Webhook') || h.textContent.includes('Campaign'));

              if (targetHeading) {
                  console.log(`[DEBUG] Found heading with text: "${targetHeading.textContent}"`);
                  const formContainer = targetHeading.closest('div[role="dialog"]');
                  if (formContainer) {
                      console.log("[DEBUG] Found form container by finding closest div[role='dialog'] to the heading.");
                      return formContainer;
                  }
                  console.log("[DEBUG] Could not find a div[role='dialog'] ancestor.");
                  return null;
              }

              console.log("[DEBUG] No heading with 'Webhook' or 'Campaign' found.");
              return null;
          }

          function addHeadersField(form) {
              console.log("[DEBUG] addHeadersField function called.");
              const container = document.createElement('div');
              container.id = 'http-headers-field-container';
              const otherField = form.querySelector('label');
              if (otherField && otherField.parentElement) {
                  container.className = otherField.parentElement.className;
              }

              const headersLabel = document.createElement('label');
              headersLabel.innerText = 'HTTP Header';
              headersLabel.htmlFor = 'http-headers-field';
              if (otherField) {
                  headersLabel.className = otherField.className;
              }

              const headersTextarea = document.createElement('textarea');
              headersTextarea.id = 'http-headers-field';
              headersTextarea.name = 'headers';
              headersTextarea.rows = 3;
              headersTextarea.placeholder = 'e.g., {"x-make-apikey": "YOUR_API_KEY"}';
              const urlInput = form.querySelector('input[name="url"]');
              if (urlInput) {
                  headersTextarea.className = urlInput.className;
              }

              container.appendChild(headersLabel);
              container.appendChild(headersTextarea);

              const saveButton = Array.from(form.querySelectorAll('button')).find(btn => btn.textContent.includes('Save') || btn.textContent.includes('Create'));
              if (saveButton && saveButton.parentElement) {
                  const parentOfButton = saveButton.parentElement;
                  parentOfButton.parentElement.insertBefore(container, parentOfButton);
                  console.log("[DEBUG] Successfully injected headers field before save button.");
              } else {
                  form.appendChild(container);
                  console.log("[DEBUG] Injected headers field as a fallback (appended to form).");
              }
          }

          const originalFetch = window.fetch;
          window.fetch = async function(url, options) {
              const method = options ? options.method || 'GET' : 'GET';
              const isWebhookSettingsUrl = typeof url === 'string' && url.includes('/api/settings/webhooks');
              const isCampaignJobUrl = typeof url === 'string' && url.includes('/api/settings/campaign-jobs');

              if ((isWebhookSettingsUrl || isCampaignJobUrl) && (method === 'POST' || method === 'PUT')) {
                  const headersTextarea = document.getElementById('http-headers-field');
                  if (headersTextarea && options.body) {
                      try {
                          console.log("[DEBUG] Intercepted save request. Adding headers to body.");
                          const body = JSON.parse(options.body);
                          let headersValue = headersTextarea.value.trim();
                          if (headersValue) {
                              try {
                                  const parsed = JSON.parse(headersValue);
                                  if (typeof parsed !== 'object' || Array.isArray(parsed) || parsed === null) {
                                      throw new Error("Headers must be a JSON object.");
                                  }
                                  body.headers = headersValue;
                              } catch (e) {
                                  console.error("[DEBUG] Invalid JSON in HTTP Headers field", e);
                                  body.headers = headersValue;
                              }
                          } else {
                              body.headers = "{}";
                          }
                          options.body = JSON.stringify(body);
                      } catch (e) {
                          console.error("[DEBUG] Could not modify fetch body for saving settings.", e);
                      }
                  }
              }

              const response = await originalFetch.apply(this, arguments);

              if (method === 'GET' && (isWebhookSettingsUrl || isCampaignJobUrl) && url.match(/\/(webhooks|campaign-jobs)\/[\w-]+$/)) {
                  const clonedResponse = response.clone();
                  clonedResponse.json().then(data => {
                      const configData = data.webhook || data.job;
                      if (configData && configData.headers) {
                          console.log("[DEBUG] Intercepted load request. Populating headers field.");
                          setTimeout(() => {
                              const headersTextarea = document.getElementById('http-headers-field');
                              if (headersTextarea) {
                                  try {
                                      const headersObj = JSON.parse(configData.headers);
                                      headersTextarea.value = JSON.stringify(headersObj, null, 2);
                                  } catch (e) {
                                      headersTextarea.value = configData.headers;
                                  }
                              }
                          }, 200);
                      }
                  });
              }

              return response;
          };
          console.log("[DEBUG] Custom script fully initialized.");
      })();
    </script>
  </body>
</html>
